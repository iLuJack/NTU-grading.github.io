{% if site.google_analytics %}
<!-- Google tag (gtag.js) -->
<script>
  // Only load analytics if user hasn't opted out
  if (!localStorage.getItem('analytics-opt-out')) {
    // Create script element dynamically
    const script = document.createElement('script');
    script.src = 'https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}';
    script.async = true;
    document.head.appendChild(script);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '{{ site.google_analytics }}', {
      'anonymize_ip': true,  // GDPR compliance
      'cookie_flags': 'SameSite=None;Secure',  // Enhanced security
      'allow_google_signals': false  // Respect privacy
    });
  }
</script>
{% endif %} 